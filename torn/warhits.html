<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn - War Hits Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <script src="torn-api.js"></script>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h1 style="margin: 0;">Torn War Hits Tracker</h1>
            <a href="faq.html" class="faq-button" title="Frequently Asked Questions">
                <span style="font-size: 20px;">❓</span> FAQ
            </a>
        </div>
        
        <!-- API Key Input Form (shown when no API key in URL) -->
        <div id="apiKeyForm" class="api-key-form">
            <p class="subtitle">Track your hits during faction wars</p>
            
            <label for="apiKey">Enter your Torn API Key:</label>
            <input type="text" id="apiKey" placeholder="Enter your API key here" />
            <p class="error" id="errorMsg">Please enter a valid API key</p>
            
            <button onclick="submitApiKey()">Start Tracking</button>
            
            <div class="info">
                <p><strong>How to get your API key:</strong></p>
                <p>1. Go to <a href="https://www.torn.com/preferences.php#tab=api" target="_blank">Torn Preferences - API</a></p>
                <p>2. Create or select an API key with <strong>"Limited Access"</strong> level</p>
                <p>3. Paste it above and click "Start Tracking"</p>
                <p><strong>Note:</strong> Your API key will be securely saved in your browser. You'll stay logged in until you click "Logout".</p>
            </div>
        </div>
        
        <!-- Tracker Content (shown when API key is in cookie) -->
        <div id="trackerContent" class="tracker-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <p class="subtitle" style="margin: 0;">Active War Hits Tracking</p>
                <button class="logout-button" onclick="logout()">Logout</button>
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" style="display: none; padding: 20px; text-align: center;">
                <p>Loading your information...</p>
            </div>
            
            <!-- Permission Warning -->
            <div id="permissionWarning" class="warning">
                <strong>⚠️ API Key Permission Issue</strong>
                <p>Your API key does not have the required permissions for this tracker to work properly.</p>
                <p><strong>Missing permissions:</strong></p>
                <ul id="missingPermissionsList"></ul>
                <p>Please create a new API key with <strong>"Limited Access"</strong> level at <a href="https://www.torn.com/preferences.php#tab=api" target="_blank">Torn Preferences - API</a></p>
            </div>
            
            <!-- Error State -->
            <div id="errorState" style="display: none; padding: 20px; background-color: #ffebee; border-radius: 4px;">
                <strong style="color: #c62828;">Error:</strong>
                <p id="errorMessage" style="color: #c62828; margin-top: 10px;"></p>
            </div>
            
            <!-- User Info Display -->
            <div id="userInfo" style="display: none;">
                <div style="background-color: #f9f9f9; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">Player Information</h3>
                    <p><strong>Username:</strong> <span id="username"></span> [<span id="userId"></span>]</p>
                    <p><strong>Faction:</strong> <span id="factionName"></span> [<span id="factionId"></span>]</p>
                </div>
                
                <div id="warInfo" style="background-color: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">War Status</h3>
                    <div id="warContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Local storage management functions (works with file:// protocol)
        function saveApiKey(apiKey) {
            try {
                localStorage.setItem('torn_api_key', apiKey);
                return true;
            } catch (e) {
                console.error('Failed to save API key:', e);
                return false;
            }
        }

        function getApiKey() {
            try {
                return localStorage.getItem('torn_api_key');
            } catch (e) {
                console.error('Failed to retrieve API key:', e);
                return null;
            }
        }

        function removeApiKey() {
            try {
                localStorage.removeItem('torn_api_key');
                return true;
            } catch (e) {
                console.error('Failed to remove API key:', e);
                return false;
            }
        }

        // Initialize page based on whether API key is in cookie
        async function initializePage() {
            const apiKey = getApiKey();
            
            if (apiKey && apiKey.trim() !== '') {
                // API key is present in localStorage, show tracker content and load data
                document.getElementById('apiKeyForm').style.display = 'none';
                document.getElementById('trackerContent').classList.add('active');
                
                // Validate API key first, then load data
                await validateAndLoadData(apiKey);
            } else {
                // No API key, show the form
                document.getElementById('apiKeyForm').style.display = 'block';
                document.getElementById('trackerContent').classList.remove('active');
            }
        }

        // Validate API key and load data
        async function validateAndLoadData(apiKey) {
            try {
                // Show loading state
                document.getElementById('loadingState').style.display = 'block';
                
                // Validate API key permissions
                const validation = await validateApiKey(apiKey);
                console.log('Validation result:', validation);
                
                // Check if key has required permissions
                if (!validation.valid) {
                    displayPermissionWarning(validation.missing);
                } else {
                    hidePermissionWarning();
                }
                
                // Load user data regardless (some features may still work)
                await loadUserData(apiKey);
                
            } catch (error) {
                console.error('Validation or loading error:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // Display permission warning with missing permissions
        function displayPermissionWarning(missingPermissions) {
            const warningDiv = document.getElementById('permissionWarning');
            const listElement = document.getElementById('missingPermissionsList');
            
            // Clear previous list
            listElement.innerHTML = '';
            
            // Add missing permissions to list
            missingPermissions.forEach(perm => {
                const li = document.createElement('li');
                li.textContent = perm;
                listElement.appendChild(li);
            });
            
            // Show warning
            warningDiv.classList.add('active');
        }

        // Hide permission warning
        function hidePermissionWarning() {
            const warningDiv = document.getElementById('permissionWarning');
            warningDiv.classList.remove('active');
        }

        // Submit API key and save to localStorage
        async function submitApiKey() {
            const apiKeyInput = document.getElementById('apiKey');
            const apiKey = apiKeyInput.value.trim();
            const errorMsg = document.getElementById('errorMsg');
            
            if (apiKey === '') {
                errorMsg.textContent = 'Please enter a valid API key';
                errorMsg.style.display = 'block';
                return;
            }
            
            errorMsg.style.display = 'none';
            
            // Disable button and show loading state
            const submitButton = event.target;
            submitButton.disabled = true;
            submitButton.textContent = 'Validating...';
            
            try {
                // Validate API key before saving
                const validation = await validateApiKey(apiKey);
                
                if (!validation.valid) {
                    errorMsg.innerHTML = `<strong>API key does not have required permissions:</strong><br>Missing: ${validation.missing.join(', ')}<br>Please create a "Limited Access" API key.`;
                    errorMsg.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Start Tracking';
                    return;
                }
                
                // Save API key to localStorage
                if (saveApiKey(apiKey)) {
                    // Reload page to show tracker
                    window.location.reload();
                } else {
                    errorMsg.textContent = 'Failed to save API key. Please check your browser settings.';
                    errorMsg.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Start Tracking';
                }
            } catch (error) {
                console.error('Validation error:', error);
                errorMsg.textContent = 'Failed to validate API key. Please check your key and try again.';
                errorMsg.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'Start Tracking';
            }
        }

        // Logout function to clear API key
        function logout() {
            removeApiKey();
            window.location.reload();
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        submitApiKey();
                    }
                });
            }
        });
    </script>
</body>
</html>