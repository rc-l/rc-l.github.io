<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn - War Hits Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <script src="auth.js"></script>
    <script src="torn-api.js"></script>
</head>
<body>
    <div style="display: flex; justify-content: flex-end; max-width: 800px; margin: 0 auto; padding: 10px 20px;">
        <div id="authContainer" class="header-auth"></div>
    </div>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h1 style="margin: 0;">Torn War Hits Tracker</h1>
            <div style="display: flex; gap: 10px;">
                <a href="index.html" class="faq-button" style="background-color: #4CAF50;" title="Back to Home">
                    ← Back
                </a>
                <a href="faq.html" class="faq-button" title="Frequently Asked Questions">
                    <span style="font-size: 20px;">❓</span> FAQ
                </a>
            </div>
        </div>
        
        <!-- Tracker Content -->
        <div id="trackerContent">
            <p class="subtitle">Track your hits during faction wars</p>
            
            <!-- Loading State -->
            <div id="loadingState" style="display: none; padding: 20px; text-align: center;">
                <p>Loading your information...</p>
            </div>
            
            <!-- Permission Warning -->
            <div id="permissionWarning" class="warning">
                <strong>⚠️ API Key Permission Issue</strong>
                <p>Your API key does not have the required permissions for this tracker to work properly.</p>
                <p><strong>Missing permissions:</strong></p>
                <ul id="missingPermissionsList"></ul>
                <p>Please create a new API key with <strong>"Limited Access"</strong> level at <a href="https://www.torn.com/preferences.php#tab=api" target="_blank">Torn Preferences - API</a></p>
            </div>
            
            <!-- Error State -->
            <div id="errorState" style="display: none; padding: 20px; background-color: #ffebee; border-radius: 4px;">
                <strong style="color: #c62828;">Error:</strong>
                <p id="errorMessage" style="color: #c62828; margin-top: 10px;"></p>
            </div>
            
            <!-- User Info Display -->
            <div id="userInfo" style="display: none;">
                <div style="background-color: #f9f9f9; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">Player Information</h3>
                    <p><strong>Username:</strong> <span id="username"></span> [<span id="userId"></span>]</p>
                    <p><strong>Faction:</strong> <span id="factionName"></span> [<span id="factionId"></span>]</p>
                </div>
                
                <div id="warInfo" style="background-color: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">War Status</h3>
                    <div id="warContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize page based on whether API key is present
        async function initializePage() {
            const apiKey = getApiKey();
            
            if (apiKey && apiKey.trim() !== '') {
                // API key is present, validate and load data
                await validateAndLoadData(apiKey);
            } else {
                // No API key, show message
                document.getElementById('trackerContent').innerHTML = `
                    <div class="info">
                        <p><strong>Please log in to track your war hits</strong></p>
                        <p>Enter your Torn API key in the login field above.</p>
                        <p><strong>How to get your API key:</strong></p>
                        <p>1. Go to <a href="https://www.torn.com/preferences.php#tab=api" target="_blank">Torn Preferences - API</a></p>
                        <p>2. Create or select an API key with <strong>"Limited Access"</strong> level</p>
                        <p>3. Enter it in the login field at the top-right of this page</p>
                    </div>
                `;
            }
        }

        // Validate API key and load data
        async function validateAndLoadData(apiKey) {
            try {
                // Show loading state
                document.getElementById('loadingState').style.display = 'block';
                
                // Validate API key permissions
                const validation = await validateApiKey(apiKey);
                console.log('Validation result:', validation);
                
                // Check if key has required permissions
                if (!validation.valid) {
                    displayPermissionWarning(validation.missing);
                } else {
                    hidePermissionWarning();
                }
                
                // Load user data regardless (some features may still work)
                await loadUserData(apiKey);
                
            } catch (error) {
                console.error('Validation or loading error:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // Display permission warning with missing permissions
        function displayPermissionWarning(missingPermissions) {
            const warningDiv = document.getElementById('permissionWarning');
            const listElement = document.getElementById('missingPermissionsList');
            
            // Clear previous list
            listElement.innerHTML = '';
            
            // Add missing permissions to list
            missingPermissions.forEach(perm => {
                const li = document.createElement('li');
                li.textContent = perm;
                listElement.appendChild(li);
            });
            
            // Show warning
            warningDiv.classList.add('active');
        }

        // Hide permission warning
        function hidePermissionWarning() {
            const warningDiv = document.getElementById('permissionWarning');
            warningDiv.classList.remove('active');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>